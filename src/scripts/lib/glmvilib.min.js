/*! glmvilib 07-05-2014 */
(function(){"use strict";var a,b,c,d,e,f={}.hasOwnProperty,g=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};d=function(a){function b(a){this.message=a,this.name="StatusError"}return g(b,a),b}(Error),c=function(a){function b(a){this.message=a,this.name="ParameterError"}return g(b,a),b}(Error),e=function(a){function b(a){this.message=a,this.name="WebGLError"}return g(b,a),b}(Error),a=function(a){function b(a){this.message=a,this.name="CapabilityError"}return g(b,a),b}(Error),b=function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K;f={NONE:0,INIT:1,REDY:2},Object.freeze(f),g="glmvilib_texture_",n=null,v=null,G=f.NONE,i=null,y={height:0,width:0,channels:0,tiles:0,dimLastTile:0,rows:0,columns:0,tilesPerTexture:0},Object.seal(y),H={availableUnits:0,reservedUnits:0,availableSize:0,internalTextures:0},Object.seal(H),C={},l={buffers:{},framebuffers:{},textures:{}},x={},w=function(b){throw b.preventDefault(),window.cancelAnimationFrame(i),new a("The rendering context was lost!",b)},F=function(b,d){var e;if(!(b instanceof HTMLCanvasElement))throw new c("Expected a HTML Canvas.");if(!window.WebGLRenderingContext)throw new a("Your browser doesn't support WebGL!");if(n=b,n.addEventListener("webglcontextlost",w,!1),e=n.getContext("webgl",d)||n.getContext("experimental-webgl",d),!e)throw new a("Your browser doesn't support WebGL!");return Object.defineProperties(H,{availableUnits:{value:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),writable:!1},availableSize:{value:e.getParameter(e.MAX_TEXTURE_SIZE),writable:!1}}),e},p=function(a,b,c){var d,e,f;return 0===a||0===c||0===b?d=f=0:(d=Math.ceil(Math.sqrt(c*a/b)),f=Math.ceil(a/d)),e={rows:f,columns:d}},D=function(b){var d,e,f,g,h,i,j,k,l,m;if("number"!=typeof b.height)throw new c("Dataset input has no 'height' attribute.");if(g=b.height,"number"!=typeof b.width)throw new c("Dataset input has no 'width' attribute.");if(m=b.width,"number"!=typeof b.channels)throw new c("Dataset input has no 'channels' attribute.");if(f=b.channels,"number"!=typeof b.reservedUnits)throw new c("Dataset input has no 'reservedUnits' attribute.");if(j=b.reservedUnits,k=Math.ceil(f/4),e=H.availableUnits-j,d=H.availableSize,l=Math.ceil(k/e),i=p(l,m,g),i.columns*m>d||i.rows*g>d)throw new a("Not enough memory available for this dataset. Needed texture dimension "+i.columns*m+" x "+i.rows*g+" but only "+d+" x "+d+" available.");return y.tiles=k,y.tilesPerTexture=l,y.height=g,y.width=m,y.rows=i.rows,y.columns=i.columns,y.channels=f,y.dimLastTile=f%4,Object.defineProperty(H,"reservedUnits",{value:j,writable:!1}),h=e>k?k:e,Object.defineProperty(H,"internalTextures",{value:h,writable:!1}),Object.freeze(y),y},B=function(){var a,b;Object.defineProperty(l.buffers,"textureCoordinateBuffer",{value:v.createBuffer(),writable:!1,enumerable:!0}),a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),v.bindBuffer(v.ARRAY_BUFFER,l.buffers.textureCoordinateBuffer),v.bufferData(v.ARRAY_BUFFER,a,v.STATIC_DRAW),Object.defineProperty(l.buffers,"vertexCoordinateBuffer",{value:v.createBuffer(),writable:!1,enumerable:!0}),b=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),v.bindBuffer(v.ARRAY_BUFFER,l.buffers.vertexCoordinateBuffer),v.bufferData(v.ARRAY_BUFFER,b,v.STATIC_DRAW)},t=function(a){var b,d;if(!a)throw new c("Bad URI '"+a+"'.");if(b=new XMLHttpRequest,b.overrideMimeType("text/plain"),b.open("get",a,!1),b.send(),!(200<=(d=b.status)&&300>d||0===b.status))throw new c(""+b.statusText);return b.responseText},A=function(a){return a},j=function(){var a,b,c,d,e,f,h;for(c="\n",d=H.internalTextures,b=H.reservedUnits,a=y.columns,h=""+y.tilesPerTexture+".0",f=1/a,e=1/y.rows,a%1===0&&(a=""+a+".0"),f%1===0&&(f=""+f+".0"),e%1===0&&(e=""+e+".0");--d>=0;)c+="uniform sampler2D "+g+(d+b)+";\n";for(c+="vec4 glmvilib_texture3D(vec2 position, float tileIdx) {\n	float index_on_sampler = mod(tileIdx, "+h+");\n	float column = mod(index_on_sampler, "+a+");\n	float row = floor(index_on_sampler / "+a+");\n\n	vec2 coords_2d = vec2(\n		"+f+" * (column + position.x),\n		"+e+" * (row + position.y)\n	);\n\n	float sampler_index = floor(tileIdx / "+h+");",d=H.internalTextures;--d>=0;)c+="\n	if (sampler_index == "+d+".0) return texture2D("+g+(d+b)+", coords_2d);";return c+="\n	return vec4(0);\n}\n"},k=function(){var a,b,c,d,e,f,h;for(c="\n",d=H.internalTextures,b=H.reservedUnits,a=y.columns,h=""+y.tilesPerTexture+".0",f=1/a,e=1/y.rows,a%1===0&&(a=""+a+".0"),f%1===0&&(f=""+f+".0"),e%1===0&&(e=""+e+".0");--d>=0;)c+="uniform sampler2D "+g+(d+b)+";\n";for(c+="mat4 glmvilib_texture3D_2pos(vec2 position_1, vec2 position_2, float tileIdx) {\n	float index_on_sampler = mod(tileIdx, "+h+");\n	float column = mod(index_on_sampler, "+a+");\n	float row = floor(index_on_sampler / "+a+");\n\n	vec2 coords_2d_1 = vec2(\n		"+f+" * (column + position_1.x),\n		"+e+" * (row + position_1.y)\n	);\n\n	vec2 coords_2d_2 = vec2(\n		"+f+" * (column + position_2.x),\n		"+e+" * (row + position_2.y)\n	);\n\n	float sampler_index = floor(tileIdx / "+h+");\n",d=H.internalTextures;--d>=0;)c+="if (sampler_index == "+d+".0) {\n	vec4 vec_1 = texture2D("+g+(d+b)+", coords_2d_1);\n	vec4 vec_2 = texture2D("+g+(d+b)+", coords_2d_2);\n	return mat4(vec_1, vec_2, vec4(0,0,0,0), vec4(0,0,0,0));\n}\n";return c+="\n	return mat4(0);\n}\n"},z=function(a){return a=a.replace(/<%=TILES=%>/g,y.tiles),a=a.replace(/<%=CHANNELS_LAST_TILE=%>/g,y.dimLastTile),a=a.replace(/<%=TEXTURE_3D=%>/,j()),a=a.replace(/<%=TEXTURE_3D_2pos=%>/,k())},o=function(a,b){if(v.shaderSource(a,b),v.compileShader(a),!v.getShaderParameter(a,v.COMPILE_STATUS)&&!v.isContextLost())throw new e(""+v.getShaderInfoLog(a));return a},s=function(a){return o(v.createShader(v.VERTEX_SHADER),a)},q=function(a){return o(v.createShader(v.FRAGMENT_SHADER),a)},r=function(a,b){var c;if(c=v.createProgram(),v.attachShader(c,a),v.attachShader(c,b),v.linkProgram(c),!v.getProgramParameter(c,v.LINK_STATUS)&&!v.isContextLost())throw new e(""+v.getProgramInfoLog(c));return c},h=function(a){var b;if(!a||"string"!=typeof a)throw new c("Expected String as texture ID but got "+a+".");return b=v.createTexture(),v.bindTexture(v.TEXTURE_2D,b),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_S,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_WRAP_T,v.CLAMP_TO_EDGE),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MIN_FILTER,v.LINEAR),v.texParameteri(v.TEXTURE_2D,v.TEXTURE_MAG_FILTER,v.NEAREST),v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!0),l.textures[a]=b},x.newTexture=h,u=function(a,b){var d,e,f,g;if(!(b instanceof Array))throw new c("Expected image array to fill texture.");if(b.length>y.rows*y.columns)throw new c("Expected "+y.rows*y.columns+" image(s) to fill the texture but got "+b.length+".");for(v.activeTexture(v.TEXTURE0),v.bindTexture(v.TEXTURE_2D,a),v.texImage2D(v.TEXTURE_2D,0,v.RGBA,y.columns*y.width,y.rows*y.height,0,v.RGBA,v.UNSIGNED_BYTE,null),e=f=0,g=b.length;g>f;e=++f)d=b[e],v.texSubImage2D(v.TEXTURE_2D,0,e%y.columns*y.width,Math.floor(e/y.columns)*y.height,v.RGBA,v.UNSIGNED_BYTE,d)},J=function(a){var b,d,e;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTextures: Expected WebGLProgram but got "+a+".");for(b=H.internalTextures,d=H.reservedUnits;b--;)e=v.getUniformLocation(a,g+(b+d)),v.uniform1i(e,b+d)},x.useInternalTextures=J,K=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalVertexPositions: Expected WebGLProgram but got "+a+".");b=v.getAttribLocation(a,"a_vertex_position"),v.enableVertexAttribArray(b),v.bindBuffer(v.ARRAY_BUFFER,l.buffers.vertexCoordinateBuffer),v.vertexAttribPointer(b,2,v.FLOAT,!1,0,0)},x.useInternalVertexPositions=K,I=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTexturePositions: Expected WebGLProgram but got "+a+".");b=v.getAttribLocation(a,"a_texture_position"),v.enableVertexAttribArray(b),v.bindBuffer(v.ARRAY_BUFFER,l.buffers.textureCoordinateBuffer),v.vertexAttribPointer(b,2,v.FLOAT,!1,0,0)},x.useInternalTexturePositions=I,m=function(){var a,b;for(a=H.internalTextures,b=H.reservedUnits;a--;)v.activeTexture(v.TEXTURE0+a+b),v.bindTexture(v.TEXTURE_2D,l.textures[g+(a+b)])},x.bindInternalTextures=m,Object.freeze(x),E=function(){var a,b,c,d;for(c=0,d=arguments.length;d>c;c++)a=arguments[c],b=C[a],v.useProgram(b.self),b.callback(v,b.self,l,x),v.drawArrays(v.TRIANGLES,0,6)},this._gl=function(){return v},this._status=function(){return G},this._animationFrameID=function(){return i},this._params=y,this._textureInfo=H,this._programs=C,this._assets=l,this._helpers=x,this._setUpWebGL=F,this._readParams=D,this._computeTilePacking=p,this._prepareGL=B,this._fetchShader=t,this._precompileVertexShader=A,this._assembleTexture3DFunction=j,this._precompileFragmentShader=z,this._compileShader=o,this._createVertexShader=s,this._createFragmentShader=q,this._createShaderProgram=r,this._addTexture=h,this._fillTexture=u,this._useInternalTextures=J,this._useInternalVertexPositions=K,this._useInternalTexturePositions=I,this._bindInternalTextures=m,this._render=E,this.init=function(a){return function(b,c){var e;if(G!==f.NONE)throw new d("glmvilib.init: glmvilib is already initialized. Call finish() first.");try{v=F(b,{preserveDrawingBuffer:!0,premultipliedAlpha:!1}),D(c),B(),G=f.INIT}catch(g){throw e=g,a.finish(),e}}}(this),this.addProgram=function(a){var b,g,h,i,j,k;if(G===f.NONE)throw new d("glmvilib.addProgram: glmvilib is not yet initialized.");if("string"!=typeof a.id)throw new c("glmvilib.addProgram: Program ID must be a String.");if(!(a.constructor instanceof Function))throw new c("glmvilib.addProgram: Program constructor must be a function.");if(a.callback&&!a.callback instanceof Function)throw new c("glmvilib.addProgram: Program callback must be a function.");try{k=t(a.vertexShaderUrl)}catch(m){throw b=m,new c("glmvilib.addProgram: Vertex shader '"+a.vertexShaderUrl+"' cannot be loaded. "+b.message)}k=A(k);try{j=s(k)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred compiling the vertex shader.\n"+b.message)}try{h=t(a.fragmentShaderUrl)}catch(m){throw b=m,new c("glmvilib.addProgram: Fragment shader '"+a.fragmentShaderUrl+"' cannot be loaded.\n"+b.message)}h=z(h);try{g=q(h)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred compiling the fragment shader.\n"+b.message)}try{i=r(j,g)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred creating the shader program '"+a.id+"'.\n"+b.message)}try{v.useProgram(i),a.constructor(v,i,l,x),v.useProgram(null)}catch(m){throw b=m,new e("glmvilib.addProgram: The constructor of '"+a.id+"' caused an error.\n"+b.message)}return C[a.id]={self:i,callback:a.callback?a.callback:function(){}},a.id},this.getTilesPerTexture=function(){return y.tilesPerTexture},this.storeTiles=function(a){var b,e,i,j,k,l,m,n,o;switch(G){case f.NONE:throw new d("glmvilib.storeTiles: glmvilib is not yet initialized.");case f.INIT:break;default:throw new d("glmvilib.storeTiles: glmvilib is already ready to render.")}if(!(a instanceof Array))throw new c("glmvilib.storeTiles: Expected an array as input.");if(a.length!==y.tiles)throw new c("glmvilib.storeTiles: Expected array length "+y.tiles+" but got "+a.length+".");for(n=0,o=a.length;o>n;n++)if(e=a[n],!(e instanceof HTMLImageElement))throw new c("glmvilib.storeTiles: Expected an array of images but got "+e+".");for(m=H.internalTextures,j=H.reservedUnits,l=y.tilesPerTexture;m--;)k=h(g+(m+j)),b=m*l,i=b+l,u(k,a.slice(b,i));G=f.REDY},this.renderUnsafe=function(a){return function(){switch(G){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}window.cancelAnimationFrame(i),E.apply(a,arguments)}}(this),this.render=function(b){return function(){var c,e,g;switch(G){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}for(e=0,g=arguments.length;g>e;e++)if(c=arguments[e],!C[c])throw new a("Program '"+c+"' does not exist.");window.cancelAnimationFrame(i),E.apply(b,arguments)}}(this),this.renderLoop=function(b){return function(){var c,e,g,h,j;switch(G){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}for(h=0,j=arguments.length;j>h;h++)if(c=arguments[h],!C[c])throw new a("Program '"+c+"' does not exist.");return g=arguments,window.cancelAnimationFrame(i),e=function(){return E.apply(b,g),i=window.requestAnimationFrame(e)},i=window.requestAnimationFrame(e),{stop:function(){return window.cancelAnimationFrame(i)}}}}(this),this.getPixels=function(a,b,e,g,h){var i;switch(G){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");if(!(h instanceof Uint8Array))throw new c("glmvilib.getPixels: Pixel array must be Uint8Array.");if(i=e*g*4,i!==h.length)throw new c("glmvilib.getPixels: Length of pixel array must be "+i+" but is "+h.length+".");v.readPixels(a,b,e,g,v.RGBA,v.UNSIGNED_BYTE,h)},this.setViewport=function(a,b,e,g){switch(G){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");v.viewport(a,b,e,g)},this.finish=function(){var a,c,d,e,f,g,h,j,k,m,o,p,q;if(window.cancelAnimationFrame(i),v){o=l.buffers;for(e in o)a=o[e],a&&v.deleteBuffer(a);p=l.framebuffers;for(e in p)c=p[e],c&&v.deleteBuffer(c);q=l.textures;for(d in q)j=q[d],j&&v.deleteTexture(j);for(d in C)if(f=C[d]){for(h=v.getAttachedShaders(f.self),k=0,m=h.length;m>k;k++)g=h[k],v.deleteShader(g);v.deleteProgram(f.self)}}n&&n.removeEventListener("webglcontextlost",w),window.glmvilib=new b,Object.freeze(window.glmvilib)}},window.glmvilib=new b,Object.freeze(window.glmvilib),window.addEventListener("beforeunload",glmvilib.finish)}).call(this);