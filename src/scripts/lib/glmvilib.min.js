/*! glmvilib 23-05-2014 */
(function(){"use strict";var a,b,c,d,e,f={}.hasOwnProperty,g=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};d=function(a){function b(a){this.message=a,this.name="StatusError"}return g(b,a),b}(Error),c=function(a){function b(a){this.message=a,this.name="ParameterError"}return g(b,a),b}(Error),e=function(a){function b(a){this.message=a,this.name="WebGLError"}return g(b,a),b}(Error),a=function(a){function b(a){this.message=a,this.name="CapabilityError"}return g(b,a),b}(Error),b=function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N;f={NONE:0,INIT:1,REDY:2},Object.freeze(f),g="glmvilib_texture_",p=null,x=null,J=f.NONE,i=null,B={height:0,width:0,channels:0,tiles:0,dimLastTile:0,rows:0,columns:0,tilesPerTexture:0},Object.seal(B),K={availableUnits:0,reservedUnits:0,availableSize:0,internalTextures:0},Object.seal(K),F={},n={buffers:{},framebuffers:{},textures:{}},z={},y=function(b){throw b.preventDefault(),window.cancelAnimationFrame(i),new a("The rendering context was lost!",b)},I=function(b,d){var e;if(!(b instanceof HTMLCanvasElement))throw new c("Expected a HTML Canvas.");if(!window.WebGLRenderingContext)throw new a("Your browser doesn't support WebGL!");if(p=b,p.addEventListener("webglcontextlost",y,!1),e=p.getContext("webgl",d)||p.getContext("experimental-webgl",d),!e)throw new a("Your browser doesn't support WebGL!");return Object.defineProperties(K,{availableUnits:{value:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),writable:!1},availableSize:{value:e.getParameter(e.MAX_TEXTURE_SIZE),writable:!1}}),e},r=function(a,b,c){var d,e,f;return 0===a||0===c||0===b?d=f=0:(d=Math.ceil(Math.sqrt(c*a/b)),f=Math.ceil(a/d)),e={rows:f,columns:d}},G=function(b){var d,e,f,g,h,i,j,k,l,m;if("number"!=typeof b.height)throw new c("Dataset input has no 'height' attribute.");if(g=b.height,"number"!=typeof b.width)throw new c("Dataset input has no 'width' attribute.");if(m=b.width,"number"!=typeof b.channels)throw new c("Dataset input has no 'channels' attribute.");if(f=b.channels,"number"!=typeof b.reservedUnits)throw new c("Dataset input has no 'reservedUnits' attribute.");if(j=b.reservedUnits,k=Math.ceil(f/4),e=K.availableUnits-j,d=K.availableSize,l=Math.ceil(k/e),i=r(l,m,g),i.columns*m>d||i.rows*g>d)throw new a("Not enough memory available for this dataset. Needed texture dimension "+i.columns*m+" x "+i.rows*g+" but only "+d+" x "+d+" available.");return B.tiles=k,B.tilesPerTexture=l,B.height=g,B.width=m,B.rows=i.rows,B.columns=i.columns,B.channels=f,B.dimLastTile=f%4,Object.defineProperty(K,"reservedUnits",{value:j,writable:!1}),h=e>k?k:e,Object.defineProperty(K,"internalTextures",{value:h,writable:!1}),Object.freeze(B),B},E=function(){var a,b;Object.defineProperty(n.buffers,"textureCoordinateBuffer",{value:x.createBuffer(),writable:!1,enumerable:!0}),a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),x.bindBuffer(x.ARRAY_BUFFER,n.buffers.textureCoordinateBuffer),x.bufferData(x.ARRAY_BUFFER,a,x.STATIC_DRAW),Object.defineProperty(n.buffers,"vertexCoordinateBuffer",{value:x.createBuffer(),writable:!1,enumerable:!0}),b=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),x.bindBuffer(x.ARRAY_BUFFER,n.buffers.vertexCoordinateBuffer),x.bufferData(x.ARRAY_BUFFER,b,x.STATIC_DRAW)},v=function(a){var b,d;if(!a)throw new c("Bad URI '"+a+"'.");if(b=new XMLHttpRequest,b.overrideMimeType("text/plain"),b.open("get",a,!1),b.send(),!(200<=(d=b.status)&&300>d||0===b.status))throw new c(""+b.statusText);return b.responseText},D=function(a){return a},A=function(a){return a%1===0?""+a+".0":""+a},k=function(){var a,b,c;for(a="",c=K.internalTextures,b=K.reservedUnits;--c>=0;)a+="uniform sampler2D "+g+(c+b)+";\n";return a},l=function(){var a,b,c;for(a="",c=K.internalTextures,b=K.reservedUnits;--c>=0;)a+="if (sampler_index == "+c+".0) return texture2D("+g+(c+b)+", coords_2d);\n";return a},j=function(a){var b,c,d;if(b="",null===a||!a[1])return b;for(a=a[1],d=K.internalTextures,c=K.reservedUnits;--d>=0;)b+="if (sampler_index == "+d+".0) {"+a.replace(/<%=SAMPLER=%>/g,""+g+(d+c))+"}\n";return b},m=function(){var a,b,c,d,e;return b="\n",a=A(B.columns),e=A(B.tilesPerTexture),d=A(1/B.columns),c=A(1/B.rows),b+=k(),b+="vec4 glmvilib_texture3D(vec2 position, float tileIdx) {\n	float index_on_sampler = mod(tileIdx, "+e+");\n	float column = mod(index_on_sampler, "+a+");\n	float row = floor(index_on_sampler / "+a+");\n\n	vec2 coords_2d = vec2(\n		"+d+" * (column + position.x),\n		"+c+" * (row + position.y)\n	);\n\n	float sampler_index = floor(tileIdx / "+e+");",b+=l(),b+="\n	return vec4(0);\n}\n"},C=function(a){var b;return a=a.replace(/<%=TILES=%>/g,B.tiles),a=a.replace(/<%=CHANNELS_LAST_TILE=%>/g,B.dimLastTile),a=a.replace(/<%=TILE_COLUMNS=%>/g,A(B.columns)),a=a.replace(/<%=TILES_PER_TEXTURE=%>/g,A(B.tilesPerTexture)),a=a.replace(/<%=TILE_WIDTH=%>/g,A(1/B.columns)),a=a.replace(/<%=TILE_HEIGHT=%>/g,A(1/B.rows)),a=a.replace(/<%=TEXTURE_3D=%>/,m()),a=a.replace(/<%=SAMPLER_DEFINITION=%>/,k()),a=a.replace(/<%=SAMPLER_QUERIES=%>/,l()),b=/<%=DYNAMIC_SAMPLER_QUERIES([\s\S]*)\n\s*=%>\n/,a=a.replace(b,j(b.exec(a)))},q=function(a,b){if(x.shaderSource(a,b),x.compileShader(a),!x.getShaderParameter(a,x.COMPILE_STATUS)&&!x.isContextLost())throw new e(""+x.getShaderInfoLog(a));return a},u=function(a){return q(x.createShader(x.VERTEX_SHADER),a)},s=function(a){return q(x.createShader(x.FRAGMENT_SHADER),a)},t=function(a,b){var c;if(c=x.createProgram(),x.attachShader(c,a),x.attachShader(c,b),x.linkProgram(c),!x.getProgramParameter(c,x.LINK_STATUS)&&!x.isContextLost())throw new e(""+x.getProgramInfoLog(c));return c},h=function(a){var b;if(!a||"string"!=typeof a)throw new c("Expected String as texture ID but got "+a+".");return b=x.createTexture(),x.bindTexture(x.TEXTURE_2D,b),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_S,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_WRAP_T,x.CLAMP_TO_EDGE),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MIN_FILTER,x.LINEAR),x.texParameteri(x.TEXTURE_2D,x.TEXTURE_MAG_FILTER,x.NEAREST),x.pixelStorei(x.UNPACK_FLIP_Y_WEBGL,!0),n.textures[a]=b},z.newTexture=h,w=function(a,b){var d,e,f,g;if(!(b instanceof Array))throw new c("Expected image array to fill texture.");if(b.length>B.rows*B.columns)throw new c("Expected "+B.rows*B.columns+" image(s) to fill the texture but got "+b.length+".");for(x.activeTexture(x.TEXTURE0),x.bindTexture(x.TEXTURE_2D,a),x.texImage2D(x.TEXTURE_2D,0,x.RGBA,B.columns*B.width,B.rows*B.height,0,x.RGBA,x.UNSIGNED_BYTE,null),e=f=0,g=b.length;g>f;e=++f)d=b[e],x.texSubImage2D(x.TEXTURE_2D,0,e%B.columns*B.width,Math.floor(e/B.columns)*B.height,x.RGBA,x.UNSIGNED_BYTE,d)},M=function(a){var b,d,e;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTextures: Expected WebGLProgram but got "+a+".");for(b=K.internalTextures,d=K.reservedUnits;b--;)e=x.getUniformLocation(a,g+(b+d)),x.uniform1i(e,b+d)},z.useInternalTextures=M,N=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalVertexPositions: Expected WebGLProgram but got "+a+".");b=x.getAttribLocation(a,"a_vertex_position"),x.enableVertexAttribArray(b),x.bindBuffer(x.ARRAY_BUFFER,n.buffers.vertexCoordinateBuffer),x.vertexAttribPointer(b,2,x.FLOAT,!1,0,0)},z.useInternalVertexPositions=N,L=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTexturePositions: Expected WebGLProgram but got "+a+".");b=x.getAttribLocation(a,"a_texture_position"),x.enableVertexAttribArray(b),x.bindBuffer(x.ARRAY_BUFFER,n.buffers.textureCoordinateBuffer),x.vertexAttribPointer(b,2,x.FLOAT,!1,0,0)},z.useInternalTexturePositions=L,o=function(){var a,b;for(a=K.internalTextures,b=K.reservedUnits;a--;)x.activeTexture(x.TEXTURE0+a+b),x.bindTexture(x.TEXTURE_2D,n.textures[g+(a+b)])},z.bindInternalTextures=o,Object.freeze(z),H=function(){var a,b,c,d;for(c=0,d=arguments.length;d>c;c++)a=arguments[c],b=F[a],x.useProgram(b.self),b.callback(x,b.self,n,z),x.drawArrays(x.TRIANGLES,0,6)},this._gl=function(){return x},this._status=function(){return J},this._animationFrameID=function(){return i},this._params=B,this._textureInfo=K,this._programs=F,this._assets=n,this._helpers=z,this._setUpWebGL=I,this._readParams=G,this._computeTilePacking=r,this._prepareGL=E,this._fetchShader=v,this._precompileVertexShader=D,this._assembleTexture3DFunction=m,this._assembleSamplerDefinition=k,this._assembleSamplerQueries=l,this._assembleDynamicSamplerQueries=j,this._numberToFloatString=A,this._precompileFragmentShader=C,this._compileShader=q,this._createVertexShader=u,this._createFragmentShader=s,this._createShaderProgram=t,this._addTexture=h,this._fillTexture=w,this._useInternalTextures=M,this._useInternalVertexPositions=N,this._useInternalTexturePositions=L,this._bindInternalTextures=o,this._render=H,this.init=function(a){return function(b,c){var e;if(J!==f.NONE)throw new d("glmvilib.init: glmvilib is already initialized. Call finish() first.");try{x=I(b,{preserveDrawingBuffer:!0,premultipliedAlpha:!1}),G(c),E(),J=f.INIT}catch(g){throw e=g,a.finish(),e}}}(this),this.addProgram=function(a){var b,g,h,i,j,k;if(J===f.NONE)throw new d("glmvilib.addProgram: glmvilib is not yet initialized.");if("string"!=typeof a.id)throw new c("glmvilib.addProgram: Program ID must be a String.");if(!(a.constructor instanceof Function))throw new c("glmvilib.addProgram: Program constructor must be a function.");if(a.callback&&!a.callback instanceof Function)throw new c("glmvilib.addProgram: Program callback must be a function.");try{k=v(a.vertexShaderUrl)}catch(l){throw b=l,new c("glmvilib.addProgram: Vertex shader '"+a.vertexShaderUrl+"' cannot be loaded. "+b.message)}k=D(k);try{j=u(k)}catch(l){throw b=l,new e("glmvilib.addProgram: An error occurred compiling the vertex shader.\n"+b.message)}try{h=v(a.fragmentShaderUrl)}catch(l){throw b=l,new c("glmvilib.addProgram: Fragment shader '"+a.fragmentShaderUrl+"' cannot be loaded.\n"+b.message)}h=C(h);try{g=s(h)}catch(l){throw b=l,new e("glmvilib.addProgram: An error occurred compiling the fragment shader.\n"+b.message)}try{i=t(j,g)}catch(l){throw b=l,new e("glmvilib.addProgram: An error occurred creating the shader program '"+a.id+"'.\n"+b.message)}try{x.useProgram(i),a.constructor(x,i,n,z),x.useProgram(null)}catch(l){throw b=l,new e("glmvilib.addProgram: The constructor of '"+a.id+"' caused an error.\n"+b.message)}return F[a.id]={self:i,callback:a.callback?a.callback:function(){}},a.id},this.getTilesPerTexture=function(){return B.tilesPerTexture},this.storeTiles=function(a){var b,e,i,j,k,l,m,n,o;switch(J){case f.NONE:throw new d("glmvilib.storeTiles: glmvilib is not yet initialized.");case f.INIT:break;default:throw new d("glmvilib.storeTiles: glmvilib is already ready to render.")}if(!(a instanceof Array))throw new c("glmvilib.storeTiles: Expected an array as input.");if(a.length!==B.tiles)throw new c("glmvilib.storeTiles: Expected array length "+B.tiles+" but got "+a.length+".");for(n=0,o=a.length;o>n;n++)if(e=a[n],!(e instanceof HTMLImageElement))throw new c("glmvilib.storeTiles: Expected an array of images but got "+e+".");for(m=K.internalTextures,j=K.reservedUnits,l=B.tilesPerTexture;m--;)k=h(g+(m+j)),b=m*l,i=b+l,w(k,a.slice(b,i));J=f.REDY},this.renderUnsafe=function(a){return function(){switch(J){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}window.cancelAnimationFrame(i),H.apply(a,arguments)}}(this),this.render=function(b){return function(){var c,e,g;switch(J){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}for(e=0,g=arguments.length;g>e;e++)if(c=arguments[e],!F[c])throw new a("Program '"+c+"' does not exist.");window.cancelAnimationFrame(i),H.apply(b,arguments)}}(this),this.renderLoop=function(b){return function(){var c,e,g,h,j;switch(J){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}for(h=0,j=arguments.length;j>h;h++)if(c=arguments[h],!F[c])throw new a("Program '"+c+"' does not exist.");return g=arguments,window.cancelAnimationFrame(i),e=function(){return H.apply(b,g),i=window.requestAnimationFrame(e)},i=window.requestAnimationFrame(e),{stop:function(){return window.cancelAnimationFrame(i)}}}}(this),this.getPixels=function(a,b,e,g,h){var i;switch(J){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");if(!(h instanceof Uint8Array))throw new c("glmvilib.getPixels: Pixel array must be Uint8Array.");if(i=e*g*4,i!==h.length)throw new c("glmvilib.getPixels: Length of pixel array must be "+i+" but is "+h.length+".");x.readPixels(a,b,e,g,x.RGBA,x.UNSIGNED_BYTE,h)},this.setViewport=function(a,b,e,g){switch(J){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");x.viewport(a,b,e,g)},this.finish=function(){var a,c,d,e,f,g,h,j,k,l,m,o,q;if(window.cancelAnimationFrame(i),x){m=n.buffers;for(e in m)a=m[e],a&&x.deleteBuffer(a);o=n.framebuffers;for(e in o)c=o[e],c&&x.deleteBuffer(c);q=n.textures;for(d in q)j=q[d],j&&x.deleteTexture(j);for(d in F)if(f=F[d]){for(h=x.getAttachedShaders(f.self),k=0,l=h.length;l>k;k++)g=h[k],x.deleteShader(g);x.deleteProgram(f.self)}}p&&p.removeEventListener("webglcontextlost",y),window.glmvilib=new b,Object.freeze(window.glmvilib)}},window.glmvilib=new b,Object.freeze(window.glmvilib),window.addEventListener("beforeunload",glmvilib.finish)}).call(this);