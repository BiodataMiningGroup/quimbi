/*! glmvilib 24-04-2014 */
(function(){"use strict";var a,b,c,d,e,f={}.hasOwnProperty,g=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};d=function(a){function b(a){this.message=a,this.name="StatusError"}return g(b,a),b}(Error),c=function(a){function b(a){this.message=a,this.name="ParameterError"}return g(b,a),b}(Error),e=function(a){function b(a){this.message=a,this.name="WebGLError"}return g(b,a),b}(Error),a=function(a){function b(a){this.message=a,this.name="CapabilityError"}return g(b,a),b}(Error),b=function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G;f={NONE:0,INIT:1,REDY:2},Object.freeze(f),g="glmvilib_texture_",s=null,C=f.NONE,i=null,u={height:0,width:0,channels:0,tiles:0,dimLastTile:0,rows:0,columns:0,tilesPerTexture:0},Object.seal(u),D={availableUnits:0,reservedUnits:0,availableSize:0,internalTextures:0},Object.seal(D),y={},k={buffers:{},framebuffers:{},textures:{}},t={},B=function(b,c){var d;if(!window.WebGLRenderingContext)throw new a("Your browser doesn't support WebGL!");if(d=b.getContext("webgl",c),!d)throw new a("Your browser doesn't support WebGL!");return Object.defineProperties(D,{availableUnits:{value:d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS),writable:!1},availableSize:{value:d.getParameter(d.MAX_TEXTURE_SIZE),writable:!1}}),d},z=function(b){var d,e,f;if("number"!=typeof b.height)throw new c("Dataset input has no 'height' attribute.");if(u.height=b.height,"number"!=typeof b.width)throw new c("Dataset input has no 'width' attribute.");if(u.width=b.width,"number"!=typeof b.channels)throw new c("Dataset input has no 'channels' attribute.");for(u.channels=b.channels,"number"==typeof b.reservedUnits&&Object.defineProperty(D,"reservedUnits",{value:b.reservedUnits,writable:!1}),u.tiles=Math.ceil(u.channels/4),u.dimLastTile=u.channels%4,d=D.availableUnits-D.reservedUnits,f=Math.ceil(u.tiles/d),u.tilesPerTexture=f,u.rows=1,u.columns=1;u.rows*u.columns<f;)u.rows*u.height>u.columns*u.width?u.columns++:u.rows++;if(Object.freeze(u),u.columns*u.width>D.availableSize||u.rows*u.height>D.availableSize)throw new a("Not enough memory available for this dataset. Needed texture dimension "+u.columns*u.width+" x "+u.rows*u.height+" but only "+D.availableSize+" x "+D.availableSize+" available.");return e=u.tiles<d?u.tiles:d,Object.defineProperty(D,"internalTextures",{value:e,writable:!1}),u},x=function(){var a,b;Object.defineProperty(k.buffers,"textureCoordinateBuffer",{value:s.createBuffer(),writable:!1,enumerable:!0}),a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),s.bindBuffer(s.ARRAY_BUFFER,k.buffers.textureCoordinateBuffer),s.bufferData(s.ARRAY_BUFFER,a,s.STATIC_DRAW),Object.defineProperty(k.buffers,"vertexCoordinateBuffer",{value:s.createBuffer(),writable:!1,enumerable:!0}),b=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s.bindBuffer(s.ARRAY_BUFFER,k.buffers.vertexCoordinateBuffer),s.bufferData(s.ARRAY_BUFFER,b,s.STATIC_DRAW)},q=function(a){var b,d;if(!a)throw new c("Bad URI '"+a+"'.");if(b=new XMLHttpRequest,b.overrideMimeType("text/plain"),b.open("get",a,!1),b.send(),!(200<=(d=b.status)&&300>d||0===b.status))throw new c(""+b.statusText);return b.responseText},w=function(a){return a},j=function(){var a,b,c,d,e,f,h;for(c="\n",d=D.internalTextures,b=D.reservedUnits,a=u.columns,h=""+u.tilesPerTexture+".0",f=1/a,e=1/u.rows,a%1===0&&(a=""+a+".0"),f%1===0&&(f=""+f+".0"),e%1===0&&(e=""+e+".0");--d>=0;)c+="uniform sampler2D "+g+(d+b)+";\n";for(c+="vec4 glmvilib_texture3D(vec2 position, float tileIdx) {\n	float index_on_sampler = mod(tileIdx, "+h+");\n	float column = mod(index_on_sampler, "+a+");\n	float row = floor(index_on_sampler / "+a+");\n\n	vec2 coords_2d = vec2(\n		"+f+" * (column + position.x),\n		"+e+" * (row + position.y)\n	);\n\n	float sampler_index = floor(tileIdx / "+h+");",d=D.internalTextures;--d>=0;)c+="\n	if (sampler_index == "+d+".0) return texture2D("+g+(d+b)+", coords_2d);";return c+="\n	return vec4(0);\n}\n"},v=function(a){return a=a.replace(/<%=TILES=%>/g,u.tiles),a=a.replace(/<%=CHANNELS_LAST_TILE=%>/g,u.dimLastTile),a=a.replace(/<%=TEXTURE_3D=%>/,j())},m=function(a,b){if(s.shaderSource(a,b),s.compileShader(a),!s.getShaderParameter(a,s.COMPILE_STATUS))throw new e(""+s.getShaderInfoLog(a));return a},p=function(a){return m(s.createShader(s.VERTEX_SHADER),a)},n=function(a){return m(s.createShader(s.FRAGMENT_SHADER),a)},o=function(a,b){var c;if(c=s.createProgram(),s.attachShader(c,a),s.attachShader(c,b),s.linkProgram(c),!s.getProgramParameter(c,s.LINK_STATUS))throw new e(""+s.getProgramInfoLog(c));return c},h=function(a){var b;if(!a||"string"!=typeof a)throw new c("Expected String as texture ID but got "+a+".");return b=s.createTexture(),s.bindTexture(s.TEXTURE_2D,b),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),k.textures[a]=b},t.newTexture=h,r=function(a,b){var d,e,f,g;if(!(b instanceof Array))throw new c("Expected image array to fill texture.");if(b.length>u.rows*u.columns)throw new c("Expected "+u.rows*u.columns+" image(s) to fill the texture but got "+b.length+".");for(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,a),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,u.columns*u.width,u.rows*u.height,0,s.RGBA,s.UNSIGNED_BYTE,null),e=f=0,g=b.length;g>f;e=++f)d=b[e],s.texSubImage2D(s.TEXTURE_2D,0,e%u.columns*u.width,Math.floor(e/u.columns)*u.height,s.RGBA,s.UNSIGNED_BYTE,d)},F=function(a){var b,d,e;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTextures: Expected WebGLProgram but got "+a+".");for(b=D.internalTextures,d=D.reservedUnits;b--;)e=s.getUniformLocation(a,g+(b+d)),s.uniform1i(e,b+d)},t.useInternalTextures=F,G=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalVertexPositions: Expected WebGLProgram but got "+a+".");b=s.getAttribLocation(a,"a_vertex_position"),s.enableVertexAttribArray(b),s.bindBuffer(s.ARRAY_BUFFER,k.buffers.vertexCoordinateBuffer),s.vertexAttribPointer(b,2,s.FLOAT,!1,0,0)},t.useInternalVertexPositions=G,E=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTexturePositions: Expected WebGLProgram but got "+a+".");b=s.getAttribLocation(a,"a_texture_position"),s.enableVertexAttribArray(b),s.bindBuffer(s.ARRAY_BUFFER,k.buffers.textureCoordinateBuffer),s.vertexAttribPointer(b,2,s.FLOAT,!1,0,0)},t.useInternalTexturePositions=E,l=function(){var a,b;for(a=D.internalTextures,b=D.reservedUnits;a--;)s.activeTexture(s.TEXTURE0+a+b),s.bindTexture(s.TEXTURE_2D,k.textures[g+(a+b)])},t.bindInternalTextures=l,Object.freeze(t),A=function(){var a,b,c,d;for(c=0,d=arguments.length;d>c;c++)a=arguments[c],b=y[a],s.useProgram(b.self),b.callback(s,b.self,k,t),s.drawArrays(s.TRIANGLES,0,6)},this._gl=function(){return s},this._status=function(){return C},this._animationFrameID=function(){return i},this._params=u,this._textureInfo=D,this._programs=y,this._assets=k,this._helpers=t,this._setUpWebGL=B,this._readParams=z,this._prepareGL=x,this._fetchShader=q,this._precompileVertexShader=w,this._assembleTexture3DFunction=j,this._precompileFragmentShader=v,this._compileShader=m,this._createVertexShader=p,this._createFragmentShader=n,this._createShaderProgram=o,this._addTexture=h,this._fillTexture=r,this._useInternalTextures=F,this._useInternalVertexPositions=G,this._useInternalTexturePositions=E,this._bindInternalTextures=l,this._render=A,this.init=function(a){return function(b,c){var e;if(C!==f.NONE)throw new d("glmvilib.init: glmvilib is already initialized. Call finish() first.");try{s=B(b,{preserveDrawingBuffer:!0,premultipliedAlpha:!1}),z(c),x(),C=f.INIT}catch(g){throw e=g,a.finish(),e}}}(this),this.addProgram=function(a){var b,g,h,i,j,l;if(C===f.NONE)throw new d("glmvilib.addProgram: glmvilib is not yet initialized.");if("string"!=typeof a.id)throw new c("glmvilib.addProgram: Program ID must be a String.");if(!(a.constructor instanceof Function))throw new c("glmvilib.addProgram: Program constructor must be a function.");if(a.callback&&!a.callback instanceof Function)throw new c("glmvilib.addProgram: Program callback must be a function.");try{l=q(a.vertexShaderUrl)}catch(m){throw b=m,new c("glmvilib.addProgram: Vertex shader '"+a.vertexShaderUrl+"' cannot be loaded. "+b.message)}l=w(l);try{j=p(l)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred compiling the vertex shader.\n"+b.message)}try{h=q(a.fragmentShaderUrl)}catch(m){throw b=m,new c("glmvilib.addProgram: Fragment shader '"+a.fragmentShaderUrl+"' cannot be loaded.\n"+b.message)}h=v(h);try{g=n(h)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred compiling the fragment shader.\n"+b.message)}try{i=o(j,g)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred creating the shader program '"+a.id+"'.\n"+b.message)}try{s.useProgram(i),a.constructor(s,i,k,t),s.useProgram(null)}catch(m){throw b=m,new e("glmvilib.addProgram: The constructor of '"+a.id+"' caused an error.\n"+b.message)}return y[a.id]={self:i,callback:a.callback?a.callback:function(){}},a.id},this.getTilesPerTexture=function(){return u.tilesPerTexture},this.storeTiles=function(a){var b,e,i,j,k,l,m,n,o;switch(C){case f.NONE:throw new d("glmvilib.storeTiles: glmvilib is not yet initialized.");case f.INIT:break;default:throw new d("glmvilib.storeTiles: glmvilib is already ready to render.")}if(!(a instanceof Array))throw new c("glmvilib.storeTiles: Expected an array as input.");if(a.length!==u.tiles)throw new c("glmvilib.storeTiles: Expected array length "+u.tiles+" but got "+a.length+".");for(n=0,o=a.length;o>n;n++)if(e=a[n],!(e instanceof HTMLImageElement))throw new c("glmvilib.storeTiles: Expected an array of images but got "+e+".");for(m=D.internalTextures,j=D.reservedUnits,l=u.tilesPerTexture;m--;)k=h(g+(m+j)),b=m*l,i=b+l,r(k,a.slice(b,i));C=f.REDY},this.renderUnsafe=function(a){return function(){var b,c;switch(C){case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");case f.REDY:break;default:throw new d("glmvilib is in undefined status.")}c=arguments,window.cancelAnimationFrame(i),b=function(){return A.apply(a,c)},i=window.requestAnimationFrame(b)}}(this),this.render=function(b){return function(){var c,e,g;switch(C){case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");case f.REDY:break;default:throw new d("glmvilib is in undefined status.")}for(e=0,g=arguments.length;g>e;e++)if(c=arguments[e],!y[c])throw new a("Program '"+c+"' does not exist.");window.cancelAnimationFrame(i),A.apply(b,arguments)}}(this),this.renderLoop=function(b){return function(){var c,e,g,h,j;switch(C){case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");case f.REDY:break;default:throw new d("glmvilib is in undefined status.")}for(h=0,j=arguments.length;j>h;h++)if(c=arguments[h],!y[c])throw new a("Program '"+c+"' does not exist.");return g=arguments,window.cancelAnimationFrame(i),e=function(){return A.apply(b,g),i=window.requestAnimationFrame(e)},i=window.requestAnimationFrame(e),{stop:function(){return window.cancelAnimationFrame(i)}}}}(this),this.getPixels=function(a,b,e,g,h){var i;switch(C){case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");case f.REDY:break;default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");if(!(h instanceof Uint8Array))throw new c("glmvilib.getPixels: Pixel array must be Uint8Array.");if(i=e*g*4,i!==h.length)throw new c("glmvilib.getPixels: Length of pixel array must be "+i+" but is "+h.length+".");s.readPixels(a,b,e,g,s.RGBA,s.UNSIGNED_BYTE,h)},this.setViewport=function(a,b,e,g){switch(C){case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");case f.REDY:break;default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");s.viewport(a,b,e,g)},this.finish=function(){var a,c,d,e,f,g,h,j,l,m,n,o,p;if(window.cancelAnimationFrame(i),s){n=k.buffers;for(e in n)a=n[e],a&&s.deleteBuffer(a);o=k.framebuffers;for(e in o)c=o[e],c&&s.deleteBuffer(c);p=k.textures;for(d in p)j=p[d],j&&s.deleteTexture(j.self);for(d in y)if(f=y[d]){for(h=s.getAttachedShaders(f.self),l=0,m=h.length;m>l;l++)g=h[l],s.deleteShader(g);s.deleteProgram(f.self)}}window.glmvilib=new b,Object.freeze(window.glmvilib)}},window.glmvilib=new b,Object.freeze(window.glmvilib),window.addEventListener("beforeunload",glmvilib.finish)}).call(this);