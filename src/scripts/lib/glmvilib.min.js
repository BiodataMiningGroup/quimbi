(function(){"use strict";var a,b,c,d,e,f={}.hasOwnProperty,g=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};d=function(a){function b(a){this.message=a,this.name="StatusError"}return g(b,a),b}(Error),c=function(a){function b(a){this.message=a,this.name="ParameterError"}return g(b,a),b}(Error),e=function(a){function b(a){this.message=a,this.name="WebGLError"}return g(b,a),b}(Error),a=function(a){function b(a){this.message=a,this.name="CapabilityError"}return g(b,a),b}(Error),b=function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E=this;f={NONE:0,INIT:1,REDY:2},Object.freeze(f),g="glmvilib_texture_",s=null,B=f.NONE,i=null,u={height:0,width:0,channels:0,tiles:0,dimLastTile:0,rows:0,columns:0},Object.seal(u),C={availableUnits:0,availableSize:0,internalTextures:0},Object.seal(C),y={},k={buffers:{},framebuffers:{},textures:{}},t={},A=function(b,c){var d;if(!window.WebGLRenderingContext)throw new a("Your browser doesn't support WebGL!");if(d=b.getContext("webgl",c),!d)throw new a("Your browser doesn't support WebGL!");return Object.defineProperties(C,{availableUnits:{value:d.getParameter(d.MAX_TEXTURE_IMAGE_UNITS),writable:!1},availableSize:{value:d.getParameter(d.MAX_TEXTURE_SIZE),writable:!1}}),d},z=function(b){var d,e;if("number"!=typeof b.height)throw new c("Dataset input has no 'height' attribute.");if(u.height=b.height,"number"!=typeof b.width)throw new c("Dataset input has no 'width' attribute.");if(u.width=b.width,"number"!=typeof b.channels)throw new c("Dataset input has no 'channels' attribute.");for(u.channels=b.channels,u.tiles=Math.ceil(u.channels/4),u.dimLastTile=u.channels%4,e=Math.ceil(u.tiles/C.availableUnits),u.rows=1,u.columns=1;u.rows*u.columns<e;)u.rows*u.height>u.columns*u.width?u.columns++:u.rows++;if(Object.freeze(u),u.columns*u.width>C.availableSize||u.rows*u.height>C.availableSize)throw new a("Not enough memory available for this dataset. Needed texture dimension #{params.columns * params.width} x #{params.rows * params.height} but only #{textureInfo.availableSize} x #{textureInfo.availableSize} available.");return d=u.tiles<C.availableUnits?u.tiles:C.availableUnits,Object.defineProperty(C,"internalTextures",{value:d,writable:!1}),u},x=function(){var a,b;Object.defineProperty(k.buffers,"textureCoordinateBuffer",{value:s.createBuffer(),writable:!1}),a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),s.bindBuffer(s.ARRAY_BUFFER,k.buffers.textureCoordinateBuffer),s.bufferData(s.ARRAY_BUFFER,a,s.STATIC_DRAW),Object.defineProperty(k.buffers,"vertexCoordinateBuffer",{value:s.createBuffer(),writable:!1}),b=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),s.bindBuffer(s.ARRAY_BUFFER,k.buffers.vertexCoordinateBuffer),s.bufferData(s.ARRAY_BUFFER,b,s.STATIC_DRAW)},q=function(a){var b,d;if(!a)throw new c("Bad URI '"+a+"'.");if(b=new XMLHttpRequest,b.overrideMimeType("text/plain"),b.open("get",a,!1),b.send(),!(200<=(d=b.status)&&300>d||0===b.status))throw new c(""+b.statusText);return b.responseText},w=function(a){return a},j=function(){var a,b,c,d,e,f;for(b="\n",c=C.internalTextures,a=u.columns,f=""+u.rows*a+".0",e=1/a,d=1/u.rows,a%1===0&&(a=""+a+".0"),e%1===0&&(e=""+e+".0"),d%1===0&&(d=""+d+".0");!(--c<0);)b+="uniform sampler2D "+g+c+";\n";for(b+="vec4 glmvilib_texture3D(vec3 position) {\n	float index_on_sampler = mod(position.z, "+f+");\n	float column = mod(index_on_sampler, "+a+");\n	float row = floor(index_on_sampler / "+a+");\n\n	vec2 coords_2d = vec2(\n		"+e+" * (column + position.x),\n		"+d+" * (row + position.y)\n	);\n	\n	float sampler_index = floor(position.z / "+f+");",c=C.internalTextures;!(--c<0);)b+="\n	if (sampler_index == "+c+".0) return texture2D("+g+c+", coords_2d);";return b+="	\n	return vec4(0);\n}\n"},v=function(a){return a=a.replace(/<%=TILES=%>/g,u.tiles),a=a.replace(/<%=CHANNELS_LAST_TILE=%>/g,u.dimLastTile),a=a.replace(/<%=TEXTURE_3D=%>/,j())},m=function(a,b){if(s.shaderSource(a,b),s.compileShader(a),!s.getShaderParameter(a,s.COMPILE_STATUS))throw new e(""+s.getShaderInfoLog(a));return a},p=function(a){return m(s.createShader(s.VERTEX_SHADER),a)},n=function(a){return m(s.createShader(s.FRAGMENT_SHADER),a)},o=function(a,b){var c;if(c=s.createProgram(),s.attachShader(c,a),s.attachShader(c,b),s.linkProgram(c),!s.getProgramParameter(c,s.LINK_STATUS))throw new e(""+s.getProgramInfoLog(c));return c},h=function(a){var b;if(!a||"string"!=typeof a)throw new c("Expected String as texture ID but got "+a+".");return b=s.createTexture(),s.bindTexture(s.TEXTURE_2D,b),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,!0),k.textures[a]=b},t.newTexture=h,r=function(a,b){var d,e,f,g;if(!(b instanceof Array))throw new c("Expected image array to fill texture.");if(b.length>u.rows*u.columns)throw new c("Expected "+u.rows*u.columns+" image(s) to fill the texture but got "+b.length+".");for(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,a),console.log(b),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,u.columns*u.width,u.rows*u.height,0,s.RGBA,s.UNSIGNED_BYTE,null),e=f=0,g=b.length;g>f;e=++f)d=b[e],s.texSubImage2D(s.TEXTURE_2D,0,e%u.columns*u.width,Math.floor(e/u.columns)*u.height,s.RGBA,s.UNSIGNED_BYTE,d)},D=function(a){var b,d;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTextures: Expected WebGLProgram but got "+a+".");for(b=C.internalTextures;b--;)d=s.getUniformLocation(a,g+b),s.uniform1i(d,b)},t.useInternalTextures=D,l=function(){var a;for(a=C.internalTextures;a--;)s.activeTexture(s.TEXTURE0+a),s.bindTexture(s.TEXTURE_2D,k.textures[g+a])},t.bindInternalTextures=l,this._gl=function(){return s},this._status=function(){return B},this._animationFrameID=function(){return i},this._params=u,this._textureInfo=C,this._programs=y,this._assets=k,this._helpers=t,this._setUpWebGL=A,this._readParams=z,this._prepareGL=x,this._fetchShader=q,this._precompileVertexShader=w,this._assembleTexture3DFunction=j,this._precompileFragmentShader=v,this._compileShader=m,this._createVertexShader=p,this._createFragmentShader=n,this._createShaderProgram=o,this._addTexture=h,this._fillTexture=r,this._useInternalTextures=D,this.init=function(a,b){var c;if(B!==f.NONE)throw new d("glmvilib.init: glmvilib is already initialized. Call finish() first.");try{s=A(a,{preserveDrawingBuffer:!0,premultipliedAlphe:!1}),z(b),x(),B=f.INIT}catch(e){throw c=e,E.finish(),c}},this.addProgram=function(a,b,g,h){var i,j,l,m,r,u;if(B===f.NONE)throw new d("glmvilib.addProgram: glmvilib is not yet initialized.");if("string"!=typeof a)throw new c("glmvilib.addProgram: Program ID must be a String.");if(!(h instanceof Function))throw new c("glmvilib.addProgram: Program constructor must be a function.");try{u=q(b)}catch(x){throw i=x,new c("glmvilib.addProgram: Vertex shader '"+b+"' cannot be loaded. "+i.message)}u=w(u);try{r=p(u)}catch(x){throw i=x,new e("glmvilib.addProgram: An error occurred compiling the vertex shader.\n"+i.message)}try{l=q(g)}catch(x){throw i=x,new c("glmvilib.addProgram: Fragment shader '"+g+"' cannot be loaded.\n"+i.message)}l=v(l);try{j=n(l)}catch(x){throw i=x,new e("glmvilib.addProgram: An error occurred compiling the fragment shader.\n"+i.message)}try{m=o(r,j)}catch(x){throw i=x,new e("glmvilib.addProgram: An error occurred creating the shader program '"+a+"'.\n"+i.message)}try{s.useProgram(m),h(s,m,k,t),s.useProgram(null)}catch(x){throw i=x,new e("glmvilib.addProgram: The constructor of '"+a+"' caused an error.\n"+i.message)}return y[a]={self:m,callback:function(){}},a},this.addProgramCallback=function(a,b){var e;if(B===f.NONE)throw new d("glmvilib.addProgramCallback: glmvilib is not yet initialized.");if("string"!=typeof a)throw new c("glmvilib.addProgramCallback: Program ID must be a String.");if(!(b instanceof Function))throw new c("glmvilib.addProgramCallback: Program callback must be a function.");if(e=y[a],!e)throw new c("glmvilib.addProgramCallback: Program '"+a+"' doesn't exist.");e.callback=b},this.storeTiles=function(a){var b,e,i,j,k,l,m,n;switch(B){case f.NONE:throw new d("glmvilib.storeTiles: glmvilib is not yet initialized.");case f.INIT:break;default:throw new d("glmvilib.storeTiles: glmvilib is already ready to render.")}if(!(a instanceof Array))throw new c("glmvilib.storeTiles: Expected an array as input.");if(a.length!==u.tiles)throw new c("glmvilib.storeTiles: Expected array length "+u.tiles+" but got "+a.length+".");for(m=0,n=a.length;n>m;m++)if(e=a[m],!(e instanceof HTMLImageElement))throw new c("glmvilib.storeTiles: Expected an array of images but got "+e+".");for(l=C.internalTextures,k=u.rows*u.columns;l--;)j=h(g+l),b=l*k,i=b+k,r(j,a.slice(b,i));B=f.REDY},this.render=function(){var a,b,c,d;for(c=0,d=arguments.length;d>c;c++)a=arguments[c],b=y[a],b&&(s.useProgram(b.self),b.callback(s,b.self,k,t),s.drawArrays(s.TRIANGLES,0,6))},this.renderLoop=function(){var b,c,e,g,h;switch(B){case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet prepared.");case f.REDY:break;default:throw new d("glmvilib is in undefined status.")}for(g=0,h=arguments.length;h>g;g++)if(b=arguments[g],!y[b])throw new a("Program '"+b+"' does not exist.");return e=arguments,window.cancelAnimationFrame(i),c=function(){return i=window.requestAnimationFrame(c),E.render.apply(E,e)},c(),{stop:function(){return window.cancelAnimationFrame(i)}}},this.finish=function(){var a,c,d,e,f,g,h,j,l,m,n,o,p;if(window.cancelAnimationFrame(i),s){for(d in y)if(f=y[d])for(h=s.getAttachedShaders(f.self),s.deleteProgram(f.self),l=0,m=h.length;m>l;l++)g=h[l],s.deleteShader(g);n=k.buffers;for(e in n)a=n[e],a&&s.deleteBuffer(a);o=k.framebuffers;for(e in o)c=o[e],c&&s.deleteBuffer(c);p=k.textures;for(d in p)j=p[d],j&&s.deleteTexture(j.self)}window.glmvilib=new b,Object.freeze(window.glmvilib)}},window.glmvilib=new b,Object.freeze(window.glmvilib),window.addEventListener("beforeunload",glmvilib.finish)}).call(this);