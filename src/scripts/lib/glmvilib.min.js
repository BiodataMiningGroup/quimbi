/*! glmvilib 07-05-2014 */
(function(){"use strict";var a,b,c,d,e,f={}.hasOwnProperty,g=function(a,b){function c(){this.constructor=a}for(var d in b)f.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};d=function(a){function b(a){this.message=a,this.name="StatusError"}return g(b,a),b}(Error),c=function(a){function b(a){this.message=a,this.name="ParameterError"}return g(b,a),b}(Error),e=function(a){function b(a){this.message=a,this.name="WebGLError"}return g(b,a),b}(Error),a=function(a){function b(a){this.message=a,this.name="CapabilityError"}return g(b,a),b}(Error),b=function(){var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J;f={NONE:0,INIT:1,REDY:2},Object.freeze(f),g="glmvilib_texture_",m=null,u=null,F=f.NONE,i=null,x={height:0,width:0,channels:0,tiles:0,dimLastTile:0,rows:0,columns:0,tilesPerTexture:0},Object.seal(x),G={availableUnits:0,reservedUnits:0,availableSize:0,internalTextures:0},Object.seal(G),B={},k={buffers:{},framebuffers:{},textures:{}},w={},v=function(b){throw b.preventDefault(),window.cancelAnimationFrame(i),new a("The rendering context was lost!",b)},E=function(b,d){var e;if(!(b instanceof HTMLCanvasElement))throw new c("Expected a HTML Canvas.");if(!window.WebGLRenderingContext)throw new a("Your browser doesn't support WebGL!");if(m=b,m.addEventListener("webglcontextlost",v,!1),e=m.getContext("webgl",d)||m.getContext("experimental-webgl",d),!e)throw new a("Your browser doesn't support WebGL!");return Object.defineProperties(G,{availableUnits:{value:e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),writable:!1},availableSize:{value:e.getParameter(e.MAX_TEXTURE_SIZE),writable:!1}}),e},o=function(a,b,c){var d,e,f;return 0===a||0===c||0===b?d=f=0:(d=Math.ceil(Math.sqrt(c*a/b)),f=Math.ceil(a/d)),e={rows:f,columns:d}},C=function(b){var d,e,f,g,h,i,j,k,l,m;if("number"!=typeof b.height)throw new c("Dataset input has no 'height' attribute.");if(g=b.height,"number"!=typeof b.width)throw new c("Dataset input has no 'width' attribute.");if(m=b.width,"number"!=typeof b.channels)throw new c("Dataset input has no 'channels' attribute.");if(f=b.channels,"number"!=typeof b.reservedUnits)throw new c("Dataset input has no 'reservedUnits' attribute.");if(j=b.reservedUnits,k=Math.ceil(f/4),e=G.availableUnits-j,d=G.availableSize,l=Math.ceil(k/e),i=o(l,m,g),i.columns*m>d||i.rows*g>d)throw new a("Not enough memory available for this dataset. Needed texture dimension "+i.columns*m+" x "+i.rows*g+" but only "+d+" x "+d+" available.");return x.tiles=k,x.tilesPerTexture=l,x.height=g,x.width=m,x.rows=i.rows,x.columns=i.columns,x.channels=f,x.dimLastTile=f%4,Object.defineProperty(G,"reservedUnits",{value:j,writable:!1}),h=e>k?k:e,Object.defineProperty(G,"internalTextures",{value:h,writable:!1}),Object.freeze(x),x},A=function(){var a,b;Object.defineProperty(k.buffers,"textureCoordinateBuffer",{value:u.createBuffer(),writable:!1,enumerable:!0}),a=new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),u.bindBuffer(u.ARRAY_BUFFER,k.buffers.textureCoordinateBuffer),u.bufferData(u.ARRAY_BUFFER,a,u.STATIC_DRAW),Object.defineProperty(k.buffers,"vertexCoordinateBuffer",{value:u.createBuffer(),writable:!1,enumerable:!0}),b=new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),u.bindBuffer(u.ARRAY_BUFFER,k.buffers.vertexCoordinateBuffer),u.bufferData(u.ARRAY_BUFFER,b,u.STATIC_DRAW)},s=function(a){var b,d;if(!a)throw new c("Bad URI '"+a+"'.");if(b=new XMLHttpRequest,b.overrideMimeType("text/plain"),b.open("get",a,!1),b.send(),!(200<=(d=b.status)&&300>d||0===b.status))throw new c(""+b.statusText);return b.responseText},z=function(a){return a},j=function(){var a,b,c,d,e,f,h;for(c="\n",d=G.internalTextures,b=G.reservedUnits,a=x.columns,h=""+x.tilesPerTexture+".0",f=1/a,e=1/x.rows,a%1===0&&(a=""+a+".0"),f%1===0&&(f=""+f+".0"),e%1===0&&(e=""+e+".0");--d>=0;)c+="uniform sampler2D "+g+(d+b)+";\n";for(c+="vec4 glmvilib_texture3D(vec2 position, float tileIdx) {\n	float index_on_sampler = mod(tileIdx, "+h+");\n	float column = mod(index_on_sampler, "+a+");\n	float row = floor(index_on_sampler / "+a+");\n\n	vec2 coords_2d = vec2(\n		"+f+" * (column + position.x),\n		"+e+" * (row + position.y)\n	);\n\n	float sampler_index = floor(tileIdx / "+h+");",d=G.internalTextures;--d>=0;)c+="\n	if (sampler_index == "+d+".0) return texture2D("+g+(d+b)+", coords_2d);";return c+="\n	return vec4(0);\n}\n"},y=function(a){return a=a.replace(/<%=TILES=%>/g,x.tiles),a=a.replace(/<%=CHANNELS_LAST_TILE=%>/g,x.dimLastTile),a=a.replace(/<%=TEXTURE_3D=%>/,j())},n=function(a,b){if(u.shaderSource(a,b),u.compileShader(a),!u.getShaderParameter(a,u.COMPILE_STATUS)&&!u.isContextLost())throw new e(""+u.getShaderInfoLog(a));return a},r=function(a){return n(u.createShader(u.VERTEX_SHADER),a)},p=function(a){return n(u.createShader(u.FRAGMENT_SHADER),a)},q=function(a,b){var c;if(c=u.createProgram(),u.attachShader(c,a),u.attachShader(c,b),u.linkProgram(c),!u.getProgramParameter(c,u.LINK_STATUS)&&!u.isContextLost())throw new e(""+u.getProgramInfoLog(c));return c},h=function(a){var b;if(!a||"string"!=typeof a)throw new c("Expected String as texture ID but got "+a+".");return b=u.createTexture(),u.bindTexture(u.TEXTURE_2D,b),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_S,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_WRAP_T,u.CLAMP_TO_EDGE),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MIN_FILTER,u.LINEAR),u.texParameteri(u.TEXTURE_2D,u.TEXTURE_MAG_FILTER,u.NEAREST),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),k.textures[a]=b},w.newTexture=h,t=function(a,b){var d,e,f,g;if(!(b instanceof Array))throw new c("Expected image array to fill texture.");if(b.length>x.rows*x.columns)throw new c("Expected "+x.rows*x.columns+" image(s) to fill the texture but got "+b.length+".");for(u.activeTexture(u.TEXTURE0),u.bindTexture(u.TEXTURE_2D,a),u.texImage2D(u.TEXTURE_2D,0,u.RGBA,x.columns*x.width,x.rows*x.height,0,u.RGBA,u.UNSIGNED_BYTE,null),e=f=0,g=b.length;g>f;e=++f)d=b[e],u.texSubImage2D(u.TEXTURE_2D,0,e%x.columns*x.width,Math.floor(e/x.columns)*x.height,u.RGBA,u.UNSIGNED_BYTE,d)},I=function(a){var b,d,e;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTextures: Expected WebGLProgram but got "+a+".");for(b=G.internalTextures,d=G.reservedUnits;b--;)e=u.getUniformLocation(a,g+(b+d)),u.uniform1i(e,b+d)},w.useInternalTextures=I,J=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalVertexPositions: Expected WebGLProgram but got "+a+".");b=u.getAttribLocation(a,"a_vertex_position"),u.enableVertexAttribArray(b),u.bindBuffer(u.ARRAY_BUFFER,k.buffers.vertexCoordinateBuffer),u.vertexAttribPointer(b,2,u.FLOAT,!1,0,0)},w.useInternalVertexPositions=J,H=function(a){var b;if(!(a instanceof WebGLProgram))throw new c("glmvilib.useInternalTexturePositions: Expected WebGLProgram but got "+a+".");b=u.getAttribLocation(a,"a_texture_position"),u.enableVertexAttribArray(b),u.bindBuffer(u.ARRAY_BUFFER,k.buffers.textureCoordinateBuffer),u.vertexAttribPointer(b,2,u.FLOAT,!1,0,0)},w.useInternalTexturePositions=H,l=function(){var a,b;for(a=G.internalTextures,b=G.reservedUnits;a--;)u.activeTexture(u.TEXTURE0+a+b),u.bindTexture(u.TEXTURE_2D,k.textures[g+(a+b)])},w.bindInternalTextures=l,Object.freeze(w),D=function(){var a,b,c,d;for(c=0,d=arguments.length;d>c;c++)a=arguments[c],b=B[a],u.useProgram(b.self),b.callback(u,b.self,k,w),u.drawArrays(u.TRIANGLES,0,6)},this._gl=function(){return u},this._status=function(){return F},this._animationFrameID=function(){return i},this._params=x,this._textureInfo=G,this._programs=B,this._assets=k,this._helpers=w,this._setUpWebGL=E,this._readParams=C,this._computeTilePacking=o,this._prepareGL=A,this._fetchShader=s,this._precompileVertexShader=z,this._assembleTexture3DFunction=j,this._precompileFragmentShader=y,this._compileShader=n,this._createVertexShader=r,this._createFragmentShader=p,this._createShaderProgram=q,this._addTexture=h,this._fillTexture=t,this._useInternalTextures=I,this._useInternalVertexPositions=J,this._useInternalTexturePositions=H,this._bindInternalTextures=l,this._render=D,this.init=function(a){return function(b,c){var e;if(F!==f.NONE)throw new d("glmvilib.init: glmvilib is already initialized. Call finish() first.");try{u=E(b,{preserveDrawingBuffer:!0,premultipliedAlpha:!1}),C(c),A(),F=f.INIT}catch(g){throw e=g,a.finish(),e}}}(this),this.addProgram=function(a){var b,g,h,i,j,l;if(F===f.NONE)throw new d("glmvilib.addProgram: glmvilib is not yet initialized.");if("string"!=typeof a.id)throw new c("glmvilib.addProgram: Program ID must be a String.");if(!(a.constructor instanceof Function))throw new c("glmvilib.addProgram: Program constructor must be a function.");if(a.callback&&!a.callback instanceof Function)throw new c("glmvilib.addProgram: Program callback must be a function.");try{l=s(a.vertexShaderUrl)}catch(m){throw b=m,new c("glmvilib.addProgram: Vertex shader '"+a.vertexShaderUrl+"' cannot be loaded. "+b.message)}l=z(l);try{j=r(l)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred compiling the vertex shader.\n"+b.message)}try{h=s(a.fragmentShaderUrl)}catch(m){throw b=m,new c("glmvilib.addProgram: Fragment shader '"+a.fragmentShaderUrl+"' cannot be loaded.\n"+b.message)}h=y(h);try{g=p(h)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred compiling the fragment shader.\n"+b.message)}try{i=q(j,g)}catch(m){throw b=m,new e("glmvilib.addProgram: An error occurred creating the shader program '"+a.id+"'.\n"+b.message)}try{u.useProgram(i),a.constructor(u,i,k,w),u.useProgram(null)}catch(m){throw b=m,new e("glmvilib.addProgram: The constructor of '"+a.id+"' caused an error.\n"+b.message)}return B[a.id]={self:i,callback:a.callback?a.callback:function(){}},a.id},this.getTilesPerTexture=function(){return x.tilesPerTexture},this.storeTiles=function(a){var b,e,i,j,k,l,m,n,o;switch(F){case f.NONE:throw new d("glmvilib.storeTiles: glmvilib is not yet initialized.");case f.INIT:break;default:throw new d("glmvilib.storeTiles: glmvilib is already ready to render.")}if(!(a instanceof Array))throw new c("glmvilib.storeTiles: Expected an array as input.");if(a.length!==x.tiles)throw new c("glmvilib.storeTiles: Expected array length "+x.tiles+" but got "+a.length+".");for(n=0,o=a.length;o>n;n++)if(e=a[n],!(e instanceof HTMLImageElement))throw new c("glmvilib.storeTiles: Expected an array of images but got "+e+".");for(m=G.internalTextures,j=G.reservedUnits,l=x.tilesPerTexture;m--;)k=h(g+(m+j)),b=m*l,i=b+l,t(k,a.slice(b,i));F=f.REDY},this.renderUnsafe=function(a){return function(){switch(F){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}window.cancelAnimationFrame(i),D.apply(a,arguments)}}(this),this.render=function(b){return function(){var c,e,g;switch(F){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}for(e=0,g=arguments.length;g>e;e++)if(c=arguments[e],!B[c])throw new a("Program '"+c+"' does not exist.");window.cancelAnimationFrame(i),D.apply(b,arguments)}}(this),this.renderLoop=function(b){return function(){var c,e,g,h,j;switch(F){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}for(h=0,j=arguments.length;j>h;h++)if(c=arguments[h],!B[c])throw new a("Program '"+c+"' does not exist.");return g=arguments,window.cancelAnimationFrame(i),e=function(){return D.apply(b,g),i=window.requestAnimationFrame(e)},i=window.requestAnimationFrame(e),{stop:function(){return window.cancelAnimationFrame(i)}}}}(this),this.getPixels=function(a,b,e,g,h){var i;switch(F){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");if(!(h instanceof Uint8Array))throw new c("glmvilib.getPixels: Pixel array must be Uint8Array.");if(i=e*g*4,i!==h.length)throw new c("glmvilib.getPixels: Length of pixel array must be "+i+" but is "+h.length+".");u.readPixels(a,b,e,g,u.RGBA,u.UNSIGNED_BYTE,h)},this.setViewport=function(a,b,e,g){switch(F){case f.REDY:break;case f.NONE:throw new d("glmvilib is not yet initialized.");case f.INIT:throw new d("glmvilib is not yet ready to render.");default:throw new d("glmvilib is in undefined status.")}if("number"!=typeof a)throw new c("glmvilib.getPixels: xOffset must be a number.");if("number"!=typeof b)throw new c("glmvilib.getPixels: yOffset must be a number.");if("number"!=typeof e)throw new c("glmvilib.getPixels: width must be a number.");if("number"!=typeof g)throw new c("glmvilib.getPixels: height must be a number.");u.viewport(a,b,e,g)},this.finish=function(){var a,c,d,e,f,g,h,j,l,n,o,p,q;if(window.cancelAnimationFrame(i),u){o=k.buffers;for(e in o)a=o[e],a&&u.deleteBuffer(a);p=k.framebuffers;for(e in p)c=p[e],c&&u.deleteBuffer(c);q=k.textures;for(d in q)j=q[d],j&&u.deleteTexture(j);for(d in B)if(f=B[d]){for(h=u.getAttachedShaders(f.self),l=0,n=h.length;n>l;l++)g=h[l],u.deleteShader(g);u.deleteProgram(f.self)}}m&&m.removeEventListener("webglcontextlost",v),window.glmvilib=new b,Object.freeze(window.glmvilib)}},window.glmvilib=new b,Object.freeze(window.glmvilib),window.addEventListener("beforeunload",glmvilib.finish)}).call(this);